<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:p="http://primefaces.org/ui"
      xmlns:c="http://xmlns.jcp.org/jsp/jstl/core"
      xmlns:fn="http://xmlns.jcp.org/jsp/jstl/functions">

<ui:composition template="/WEB-INF/templates/template.xhtml">
    
    <ui:define name="title">
        #{msg['admin.users.title']} - #{applicationBean.applicationName}
    </ui:define>
    
    <ui:define name="css">
        <!-- Referência: Sistema de Temas Claros e Escuros - project_rules.md -->
        <style type="text/css">
            .admin-header {
                background: linear-gradient(135deg, var(--blue-primary) 0%, var(--blue-secondary) 100%);
                color: var(--text-on-primary);
                padding: 2rem 0;
                margin-bottom: 2rem;
                border-radius: 10px;
                box-shadow: var(--shadow-lg);
            }
            
            .admin-title {
                font-size: 2rem;
                font-weight: bold;
                margin-bottom: 0.5rem;
            }
            
            .admin-subtitle {
                opacity: 0.9;
                font-size: 1.1rem;
            }
            
            .stats-cards {
                margin-bottom: 2rem;
            }
            
            .stat-card {
                background: var(--bg-primary);
                border-radius: 10px;
                padding: 1.5rem;
                box-shadow: var(--shadow-md);
                text-align: center;
                transition: all 0.3s ease;
                border: 1px solid var(--border-color);
            }
            
            .stat-card:hover {
                transform: translateY(-2px);
                box-shadow: var(--shadow-lg);
            }
            
            .stat-icon {
                font-size: 2.5rem;
                margin-bottom: 1rem;
            }
            
            .stat-number {
                font-size: 2rem;
                font-weight: bold;
                color: var(--text-primary);
                margin-bottom: 0.5rem;
            }
            
            .stat-label {
                color: var(--text-secondary);
                font-size: 0.9rem;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }
            
            .stat-total { color: var(--blue-secondary); }
            .stat-active { color: var(--success-color); }
            .stat-inactive { color: var(--warning-color); }
            .stat-recent { color: var(--purple-color); }
            
            .filters-panel {
                background: var(--bg-primary);
                border-radius: 10px;
                padding: 1.5rem;
                margin-bottom: 2rem;
                box-shadow: var(--shadow-md);
                border: 1px solid var(--border-color);
            }
            
            .data-table-container {
                background: var(--bg-primary);
                border-radius: 10px;
                padding: 1.5rem;
                box-shadow: var(--shadow-md);
                border: 1px solid var(--border-color);
            }
            
            .user-avatar {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                background: var(--border-color);
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: bold;
                color: var(--text-primary);
                margin-right: 0.75rem;
            }
            
            .user-info {
                display: flex;
                align-items: center;
            }
            
            .user-details {
                flex: 1;
            }
            
            .user-name {
                font-weight: 600;
                color: var(--text-primary);
                margin-bottom: 0.25rem;
            }
            
            .user-email {
                color: var(--text-secondary);
                font-size: 0.9rem;
            }
            
            .status-badge {
                padding: 0.25rem 0.75rem;
                border-radius: 20px;
                font-size: 0.8rem;
                font-weight: 500;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }
            
            .status-active {
                background: #d1fae5;
                color: #065f46;
            }
            
            .status-inactive {
                background: #fef3c7;
                color: #92400e;
            }
            
            .action-buttons {
                display: flex;
                gap: 0.5rem;
            }
            
            .btn-sm {
                padding: 0.375rem 0.75rem;
                font-size: 0.875rem;
            }
            
            .toolbar {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 1.5rem;
                flex-wrap: wrap;
                gap: 1rem;
            }
            
            .bulk-actions {
                display: flex;
                gap: 0.5rem;
                align-items: center;
            }
            
            .search-box {
                min-width: 300px;
            }
            
            .dialog-content {
                padding: 1rem;
            }
            
            .form-group {
                margin-bottom: 1.5rem;
            }
            
            .form-label {
                display: block;
                margin-bottom: 0.5rem;
                font-weight: 600;
                color: #374151;
            }
            
            .required {
                color: #dc2626;
            }
            
            .password-strength {
                margin-top: 0.5rem;
                font-size: 0.8rem;
            }
            
            .strength-weak { color: #dc2626; }
            .strength-medium { color: #f59e0b; }
            .strength-strong { color: #10b981; }
            
            @media (max-width: 768px) {
                .admin-title {
                    font-size: 1.5rem;
                }
                
                .toolbar {
                    flex-direction: column;
                    align-items: stretch;
                }
                
                .search-box {
                    min-width: auto;
                }
                
                .bulk-actions {
                    justify-content: center;
                }
                
                .action-buttons {
                    flex-direction: column;
                }
            }
        </style>
    </ui:define>
    
    <ui:define name="content">
        <!-- Referência: Sistema de Temas Claros e Escuros - project_rules.md -->
        <!-- Referência: Controle de Acesso - project_rules.md -->
        
        <!-- Controle de acesso: apenas ADMINISTRADOR ou FUNDADOR -->
        <c:if test="#{authBean.hasRole('ADMINISTRADOR') or authBean.hasRole('FUNDADOR')}">
        
        <!-- Cabeçalho Admin -->
        <div class="admin-header">
            <div class="container">
                <div class="row">
                    <div class="col-12">
                        <h1 class="admin-title">
                            <i class="pi pi-users"></i>
                            #{msg['admin.users.title']}
                        </h1>
                        <p class="admin-subtitle">#{msg['admin.users.subtitle']}</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="container">
            <!-- Cards de Estatísticas -->
            <div class="stats-cards">
                <div class="row">
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="stat-card">
                            <div class="stat-icon stat-total">
                                <i class="pi pi-users"></i>
                            </div>
                            <div class="stat-number">#{usuarioAdminBean.totalUsuarios}</div>
                            <div class="stat-label">#{msg['admin.stats.total.users']}</div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="stat-card">
                            <div class="stat-icon stat-active">
                                <i class="pi pi-check-circle"></i>
                            </div>
                            <div class="stat-number">#{usuarioAdminBean.usuariosAtivos}</div>
                            <div class="stat-label">#{msg['admin.stats.active.users']}</div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="stat-card">
                            <div class="stat-icon stat-inactive">
                                <i class="pi pi-times-circle"></i>
                            </div>
                            <div class="stat-number">#{usuarioAdminBean.usuariosInativos}</div>
                            <div class="stat-label">#{msg['admin.stats.inactive.users']}</div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="stat-card">
                            <div class="stat-icon stat-recent">
                                <i class="pi pi-calendar-plus"></i>
                            </div>
                            <div class="stat-number">#{usuarioAdminBean.usuariosRecentes}</div>
                            <div class="stat-label">#{msg['admin.stats.recent.users']}</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Painel de Filtros -->
            <div class="filters-panel">
                <h:form id="filtersForm">
                    <div class="row align-items-end">
                        <div class="col-lg-3 col-md-6 mb-3">
                            <label class="form-label">#{msg['filter.status']}</label>
                            <p:selectOneMenu value="#{usuarioAdminBean.filtroStatus}" 
                                           styleClass="form-control">
                                <f:selectItem itemLabel="#{msg['filter.all']}" itemValue=""/>
                                <f:selectItem itemLabel="#{msg['status.active']}" itemValue="true"/>
                                <f:selectItem itemLabel="#{msg['status.inactive']}" itemValue="false"/>
                            </p:selectOneMenu>
                        </div>
                        
                        <div class="col-lg-3 col-md-6 mb-3">
                            <label class="form-label">#{msg['filter.date.from']}</label>
                            <p:calendar value="#{usuarioAdminBean.dataInicio}" 
                                      pattern="#{msg['date.format.input']}"
                                      showOn="button"
                                      styleClass="form-control"/>
                        </div>
                        
                        <div class="col-lg-3 col-md-6 mb-3">
                            <label class="form-label">#{msg['filter.date.to']}</label>
                            <p:calendar value="#{usuarioAdminBean.dataFim}" 
                                      pattern="#{msg['date.format.input']}"
                                      showOn="button"
                                      styleClass="form-control"/>
                        </div>
                        
                        <div class="col-lg-3 col-md-6 mb-3">
                            <p:commandButton value="#{msg['button.filter']}" 
                                           action="#{usuarioAdminBean.aplicarFiltros}"
                                           update="usersTable"
                                           styleClass="btn btn-primary me-2"
                                           icon="pi pi-search"/>
                            <p:commandButton value="#{msg['button.clear']}" 
                                           action="#{usuarioAdminBean.limparFiltros}"
                                           update="filtersForm usersTable"
                                           styleClass="btn btn-outline-secondary"
                                           icon="pi pi-times"/>
                        </div>
                    </div>
                </h:form>
            </div>
            
            <!-- Tabela de Usuários -->
            <div class="data-table-container">
                <div class="toolbar">
                    <div class="bulk-actions">
                        <p:commandButton value="#{msg['button.new.user']}" 
                                       onclick="PF('userDialog').show()" 
                                       styleClass="btn btn-success"
                                       icon="pi pi-plus"/>
                        
                        <p:commandButton value="#{msg['button.activate.selected']}" 
                                       action="#{usuarioAdminBean.ativarSelecionados}"
                                       update="usersTable"
                                       styleClass="btn btn-outline-success btn-sm"
                                       icon="pi pi-check"
                                       disabled="#{empty usuarioAdminBean.usuariosSelecionados}"/>
                        
                        <p:commandButton value="#{msg['button.deactivate.selected']}" 
                                       action="#{usuarioAdminBean.desativarSelecionados}"
                                       update="usersTable"
                                       styleClass="btn btn-outline-warning btn-sm"
                                       icon="pi pi-times"
                                       disabled="#{empty usuarioAdminBean.usuariosSelecionados}"/>
                    </div>
                    
                    <div class="search-box">
                        <h:form>
                            <p:inputText value="#{usuarioAdminBean.termoPesquisa}" 
                                       placeholder="#{msg['search.placeholder']}"
                                       styleClass="form-control">
                                <p:ajax event="keyup" 
                                      listener="#{usuarioAdminBean.pesquisar}" 
                                      update="usersTable" 
                                      delay="500"/>
                            </p:inputText>
                        </h:form>
                    </div>
                </div>
                
                <h:form id="usersTableForm">
                    <p:dataTable id="usersTable" 
                               value="#{usuarioAdminBean.usuarios}" 
                               var="usuario"
                               lazy="true"
                               paginator="true"
                               rows="20"
                               paginatorPosition="both"
                               paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
                               rowsPerPageTemplate="10,20,50"
                               selection="#{usuarioAdminBean.usuariosSelecionados}"
                               rowKey="#{usuario.id}"
                               styleClass="table table-striped"
                               emptyMessage="#{msg['table.no.records']}"
                               currentPageReportTemplate="#{msg['table.pagination.template']}">
                        
                        <p:column selectionMode="multiple" style="width:3rem"/>
                        
                        <p:column headerText="#{msg['table.user.info']}" sortBy="#{usuario.nome}">
                            <div class="user-info">
                                <div class="user-avatar">
                                    #{fn:substring(usuario.nome, 0, 1)}
                                </div>
                                <div class="user-details">
                                    <div class="user-name">#{usuario.nome}</div>
                                    <div class="user-email">#{usuario.email}</div>
                                </div>
                            </div>
                        </p:column>
                        
                        <p:column headerText="#{msg['table.status']}" sortBy="#{usuario.ativo}" style="width:8rem">
                            <span class="status-badge #{usuario.ativo ? 'status-active' : 'status-inactive'}">
                                <i class="pi #{usuario.ativo ? 'pi-check' : 'pi-times'}"></i>
                                #{usuario.ativo ? msg['status.active'] : msg['status.inactive']}
                            </span>
                        </p:column>
                        
                        <p:column headerText="#{msg['table.created.date']}" sortBy="#{usuario.dataCriacao}" style="width:10rem">
                            <h:outputText value="#{usuario.dataCriacao}">
                                <f:convertDateTime pattern="#{msg['date.format.short']}"/>
                            </h:outputText>
                        </p:column>
                        
                        <p:column headerText="#{msg['table.last.update']}" sortBy="#{usuario.dataAtualizacao}" style="width:10rem">
                            <h:outputText value="#{usuario.dataAtualizacao}">
                                <f:convertDateTime pattern="#{msg['date.format.short']}"/>
                            </h:outputText>
                        </p:column>
                        
                        <p:column headerText="#{msg['table.actions']}" style="width:12rem">
                            <div class="action-buttons">
                                <p:commandButton icon="pi pi-pencil" 
                                               title="#{msg['button.edit']}"
                                               action="#{usuarioAdminBean.editarUsuario(usuario)}"
                                               oncomplete="PF('userDialog').show()"
                                               update="userDialogContent"
                                               styleClass="btn btn-outline-primary btn-sm"/>
                                
                                <p:commandButton icon="#{usuario.ativo ? 'pi pi-times' : 'pi pi-check'}" 
                                               title="#{usuario.ativo ? msg['button.deactivate'] : msg['button.activate']}"
                                               action="#{usuarioAdminBean.alternarStatus(usuario)}"
                                               update="usersTable"
                                               styleClass="btn #{usuario.ativo ? 'btn-outline-warning' : 'btn-outline-success'} btn-sm">
                                    <p:confirm header="#{msg['confirm.title']}" 
                                             message="#{usuario.ativo ? msg['confirm.deactivate.user'] : msg['confirm.activate.user']}"
                                             icon="pi pi-exclamation-triangle"/>
                                </p:commandButton>
                                
                                <p:commandButton icon="pi pi-key" 
                                               title="#{msg['button.reset.password']}"
                                               action="#{usuarioAdminBean.resetarSenha(usuario)}"
                                               update="usersTable"
                                               styleClass="btn btn-outline-info btn-sm">
                                    <p:confirm header="#{msg['confirm.title']}" 
                                             message="#{msg['confirm.reset.password']}"
                                             icon="pi pi-exclamation-triangle"/>
                                </p:commandButton>
                            </div>
                        </p:column>
                    </p:dataTable>
                </h:form>
            </div>
        </div>
        
        <!-- Dialog de Usuário -->
        <p:dialog id="userDialog" 
                widgetVar="userDialog" 
                header="#{usuarioAdminBean.editando ? msg['dialog.edit.user'] : msg['dialog.new.user']}"
                modal="true" 
                width="600" 
                height="500"
                resizable="false"
                closeOnEscape="true">
            
            <div id="userDialogContent">
                <h:form id="userForm">
                    <div class="dialog-content">
                        <div class="form-group">
                            <label class="form-label">
                                #{msg['form.name']} <span class="required">*</span>
                            </label>
                            <p:inputText value="#{usuarioAdminBean.usuarioEdicao.nome}" 
                                       styleClass="form-control"
                                       required="true"
                                       requiredMessage="#{msg['validation.name.required']}"
                                       maxlength="100"/>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                #{msg['form.email']} <span class="required">*</span>
                            </label>
                            <p:inputText value="#{usuarioAdminBean.usuarioEdicao.email}" 
                                       styleClass="form-control"
                                       required="true"
                                       requiredMessage="#{msg['validation.email.required']}"
                                       validatorMessage="#{msg['validation.email.invalid']}"
                                       maxlength="150">
                                <f:validateRegex pattern="^[\w\.-]+@[\w\.-]+\.[a-zA-Z]{2,}$"/>
                            </p:inputText>
                        </div>
                        
                        <div class="form-group" rendered="#{not usuarioAdminBean.editando}">
                            <label class="form-label">
                                #{msg['form.password']} <span class="required">*</span>
                            </label>
                            <p:password value="#{usuarioAdminBean.usuarioEdicao.senha}" 
                                      styleClass="form-control"
                                      required="#{not usuarioAdminBean.editando}"
                                      requiredMessage="#{msg['validation.password.required']}"
                                      feedback="true"
                                      promptLabel="#{msg['password.prompt']}"
                                      weakLabel="#{msg['password.weak']}"
                                      goodLabel="#{msg['password.good']}"
                                      strongLabel="#{msg['password.strong']}"/>
                        </div>
                        
                        <div class="form-group">
                            <p:selectBooleanCheckbox value="#{usuarioAdminBean.usuarioEdicao.ativo}" 
                                                   itemLabel="#{msg['form.active.user']}"/>
                        </div>
                        
                        <div class="form-group" rendered="#{usuarioAdminBean.editando}">
                            <p:selectBooleanCheckbox value="#{usuarioAdminBean.resetarSenhaUsuario}" 
                                                   itemLabel="#{msg['form.reset.password']}"/>
                            <small class="form-text text-muted">#{msg['form.reset.password.help']}</small>
                        </div>
                    </div>
                    
                    <div class="dialog-footer d-flex justify-content-end gap-2 mt-3">
                        <p:commandButton value="#{msg['button.cancel']}" 
                                       onclick="PF('userDialog').hide()" 
                                       styleClass="btn btn-outline-secondary"
                                       type="button"/>
                        
                        <p:commandButton value="#{msg['button.save']}" 
                                       action="#{usuarioAdminBean.salvarUsuario}"
                                       update="usersTable userDialogContent"
                                       oncomplete="if (args && !args.validationFailed) PF('userDialog').hide()"
                                       styleClass="btn btn-primary"
                                       icon="pi pi-save"/>
                    </div>
                </h:form>
            </div>
        </p:dialog>
        
        <!-- Confirmação -->
        <p:confirmDialog global="true" showEffect="fade" hideEffect="fade" responsive="true" width="350">
            <p:commandButton value="#{msg['button.yes']}" type="button" styleClass="btn btn-primary ui-confirmdialog-yes" icon="pi pi-check"/>
            <p:commandButton value="#{msg['button.no']}" type="button" styleClass="btn btn-outline-secondary ui-confirmdialog-no" icon="pi pi-times"/>
        </p:confirmDialog>
    </ui:define>
    
    <ui:define name="javascript">
        <script type="text/javascript">
            // Atualizar estatísticas periodicamente
            function updateStats() {
                if (typeof PrimeFaces !== 'undefined') {
                    // Implementar atualização automática das estatísticas
                }
            }
            
            // Atualizar a cada 30 segundos
            setInterval(updateStats, 30000);
            
            // Validação de formulário em tempo real
            document.addEventListener('DOMContentLoaded', function() {
                const emailInput = document.querySelector('input[id*="email"]');
                if (emailInput) {
                    emailInput.addEventListener('blur', function() {
                        const email = this.value;
                        const emailRegex = /^[\w\.-]+@[\w\.-]+\.[a-zA-Z]{2,}$/;
                        
                        if (email && !emailRegex.test(email)) {
                            this.style.borderColor = '#dc3545';
                        } else {
                            this.style.borderColor = '#ced4da';
                        }
                    });
                }
            });
            
            // Função para exportar dados
            function exportUsers() {
                // Implementar exportação de usuários
                console.log('Exportando usuários...');
            }
            
            // Atalhos de teclado
            document.addEventListener('keydown', function(e) {
                // Ctrl+N para novo usuário
                if (e.ctrlKey && e.key === 'n') {
                    e.preventDefault();
                    PF('userDialog').show();
                }
                
                // Escape para fechar dialogs
                if (e.key === 'Escape') {
                    if (PF('userDialog').isVisible()) {
                        PF('userDialog').hide();
                    }
                }
            });
        </script>
    </ui:define>
    
    <!-- Fechamento do controle de acesso -->
    </c:if>
    
    <!-- Mensagem de acesso negado -->
    <c:if test="#{not (authBean.hasRole('ADMINISTRADOR') or authBean.hasRole('FUNDADOR'))}">
        <div class="container mt-5">
            <div class="alert alert-danger text-center">
                <h4><i class="pi pi-exclamation-triangle"></i> #{msg['access.denied.title']}</h4>
                <p>#{msg['access.denied.admin.message']}</p>
                <p:button value="#{msg['button.back.home']}" outcome="/index" styleClass="btn btn-primary"/>
            </div>
        </div>
    </c:if>
    
</ui:composition>
</html>