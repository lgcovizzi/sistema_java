<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:p="http://primefaces.org/ui"
      xmlns:c="http://xmlns.jcp.org/jsp/jstl/core">

<ui:composition template="/WEB-INF/templates/template.xhtml">
    
    <ui:define name="title">
        #{noticiaDetalhesBean.noticia.titulo} - #{applicationBean.applicationName}
    </ui:define>
    
    <ui:define name="css">
        <!-- Referência: Sistema de Temas Claros e Escuros - project_rules.md -->
        <style type="text/css">
            .article-header {
                background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--border-color) 100%);
                padding: 3rem 0;
                margin-bottom: 2rem;
                border-radius: 10px;
                box-shadow: var(--shadow-sm);
            }
            
            .article-meta {
                color: var(--text-secondary);
                font-size: 1rem;
                margin-bottom: 1rem;
            }
            
            .article-meta .meta-item {
                margin-right: 1.5rem;
                display: inline-flex;
                align-items: center;
                gap: 0.5rem;
            }
            
            .article-title {
                font-size: 2.5rem;
                font-weight: bold;
                color: var(--text-primary);
                line-height: 1.2;
                margin-bottom: 1rem;
            }
            
            .article-summary {
                font-size: 1.2rem;
                color: var(--text-secondary);
                line-height: 1.6;
                margin-bottom: 2rem;
            }
            
            .category-tags {
                margin-bottom: 1rem;
            }
            
            .category-tag {
                background: var(--blue-light);
                color: var(--blue-primary);
                padding: 0.5rem 1rem;
                border-radius: 20px;
                font-size: 0.9rem;
                font-weight: 500;
                margin-right: 0.75rem;
                margin-bottom: 0.5rem;
                display: inline-block;
                text-decoration: none;
                transition: all 0.3s ease;
            }
            
            .category-tag:hover {
                background: var(--blue-primary);
                color: var(--bg-primary);
                transform: translateY(-1px);
                box-shadow: var(--shadow-md);
            }
            
            .article-image {
                width: 100%;
                height: 400px;
                object-fit: cover;
                border-radius: 10px;
                margin-bottom: 2rem;
                box-shadow: var(--shadow-md);
            }
            
            .article-content {
                font-size: 1.1rem;
                line-height: 1.8;
                color: var(--text-primary);
                margin-bottom: 3rem;
            }
            
            .article-content p {
                margin-bottom: 1.5rem;
            }
            
            .article-content h2,
            .article-content h3,
            .article-content h4 {
                color: var(--text-primary);
                margin-top: 2rem;
                margin-bottom: 1rem;
            }
            
            .article-actions {
                background: var(--bg-secondary);
                padding: 1.5rem;
                border-radius: 10px;
                margin-bottom: 3rem;
                display: flex;
                justify-content: space-between;
                align-items: center;
                flex-wrap: wrap;
                gap: 1rem;
                border: 1px solid var(--border-color);
            }
            
            .social-share {
                display: flex;
                gap: 0.5rem;
            }
            
            .share-button {
                padding: 0.5rem;
                border-radius: 50%;
                color: var(--bg-primary);
                text-decoration: none;
                transition: all 0.3s ease;
                box-shadow: var(--shadow-sm);
            }
            
            .share-button:hover {
                transform: scale(1.1);
                box-shadow: var(--shadow-md);
            }
            
            .share-facebook { background: #1877f2; }
            .share-twitter { background: #1da1f2; }
            .share-linkedin { background: #0077b5; }
            .share-whatsapp { background: #25d366; }
            
            .comments-section {
                background: var(--bg-primary);
                border-radius: 10px;
                padding: 2rem;
                box-shadow: var(--shadow-md);
                margin-bottom: 2rem;
                border: 1px solid var(--border-color);
            }
            
            .comments-header {
                border-bottom: 2px solid var(--border-color);
                padding-bottom: 1rem;
                margin-bottom: 2rem;
                color: var(--text-primary);
            }
            
            .comment-item {
                border-left: 4px solid var(--border-color);
                padding: 1.5rem;
                margin-bottom: 1.5rem;
                background: var(--bg-secondary);
                border-radius: 0 10px 10px 0;
                transition: all 0.3s ease;
            }
            
            .comment-item:hover {
                border-left-color: var(--blue-primary);
                background: var(--blue-light);
                box-shadow: var(--shadow-sm);
            }
            
            .comment-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 1rem;
            }
            
            .comment-author {
                font-weight: 600;
                color: var(--text-primary);
            }
            
            .comment-date {
                color: var(--text-secondary);
                font-size: 0.9rem;
            }
            
            .comment-content {
                color: var(--text-primary);
                line-height: 1.6;
            }
            
            .comment-form {
                background: var(--bg-secondary);
                padding: 2rem;
                border-radius: 10px;
                margin-top: 2rem;
                border: 1px solid var(--border-color);
            }
            
            .related-news {
                background: var(--bg-primary);
                border-radius: 10px;
                padding: 2rem;
                box-shadow: var(--shadow-md);
                border: 1px solid var(--border-color);
            }
            
            .related-item {
                display: flex;
                gap: 1rem;
                padding: 1rem;
                border-radius: 8px;
                transition: all 0.3s ease;
                margin-bottom: 1rem;
            }
            
            .related-item:hover {
                background: var(--bg-secondary);
                box-shadow: var(--shadow-sm);
            }
            
            .related-image {
                width: 80px;
                height: 60px;
                object-fit: cover;
                border-radius: 6px;
                flex-shrink: 0;
            }
            
            .related-content {
                flex: 1;
            }
            
            .related-title {
                font-size: 0.95rem;
                font-weight: 600;
                color: var(--text-primary);
                line-height: 1.3;
                margin-bottom: 0.5rem;
                text-decoration: none;
            }
            
            .related-title:hover {
                color: var(--blue-primary);
            }
            
            .related-date {
                color: var(--text-secondary);
                font-size: 0.8rem;
            }
            
            .back-button {
                margin-bottom: 2rem;
            }
            
            .article-stats {
                display: flex;
                gap: 1rem;
                color: var(--text-secondary);
                font-size: 0.9rem;
            }
            
            .stat-item {
                display: flex;
                align-items: center;
                gap: 0.3rem;
            }
            
            .stat-item i {
                color: var(--blue-primary);
            }
            
            @media (max-width: 768px) {
                .article-title {
                    font-size: 2rem;
                }
                
                .article-actions {
                    flex-direction: column;
                    align-items: stretch;
                }
                
                .social-share {
                    justify-content: center;
                }
                
                .related-item {
                    flex-direction: column;
                }
                
                .related-image {
                    width: 100%;
                    height: 120px;
                }
            }
        </style>
    </ui:define>
    
    <ui:define name="content">
        <!-- Referência: Controle de Acesso - project_rules.md -->
        <!-- Verificação se a notícia está publicada ou se o usuário tem permissão para visualizar -->
        <c:if test="#{not noticiaDetalhesBean.noticia.publicada and (empty usuarioLogado or not usuarioLogado.isAdministradorOuColaborador())}">
            <div class="container">
                <div class="alert alert-warning text-center">
                    <h4><i class="pi pi-exclamation-triangle"></i> Notícia não encontrada</h4>
                    <p>A notícia solicitada não está disponível ou foi removida.</p>
                    <p:commandButton value="Voltar para Lista" action="/noticias/lista" styleClass="btn btn-primary"/>
                </div>
            </div>
        </c:if>
        
        <c:if test="#{noticiaDetalhesBean.noticia.publicada or (not empty usuarioLogado and usuarioLogado.isAdministradorOuColaborador())}">
            <!-- Alerta para notícia não publicada (apenas para administradores/colaboradores) -->
            <c:if test="#{not noticiaDetalhesBean.noticia.publicada and not empty usuarioLogado and usuarioLogado.isAdministradorOuColaborador()}">
                <div class="container">
                    <div class="alert alert-info">
                        <i class="pi pi-info-circle"></i> Esta notícia ainda não foi publicada e só é visível para administradores e colaboradores.
                    </div>
                </div>
            </c:if>
        <!-- Botão Voltar -->
        <div class="container">
            <div class="back-button">
                <p:commandButton value="#{msg['button.back']}" 
                               action="#{noticiaDetalhesBean.voltarParaLista}"
                               styleClass="btn btn-outline-secondary"
                               icon="pi pi-arrow-left"/>
            </div>
        </div>
        
        <!-- Cabeçalho do Artigo -->
        <div class="article-header">
            <div class="container">
                <div class="row">
                    <div class="col-lg-8 mx-auto">
                        <!-- Meta informações -->
                        <div class="article-meta">
                            <span class="meta-item">
                                <i class="pi pi-calendar"></i>
                                <h:outputText value="#{noticiaDetalhesBean.noticia.dataPublicacao}">
                                    <f:convertDateTime pattern="#{msg['date.format.full']}"/>
                                </h:outputText>
                            </span>
                            <span class="meta-item">
                                <i class="pi pi-user"></i>
                                #{noticiaDetalhesBean.noticia.autor.nome}
                            </span>
                            <span class="meta-item">
                                <i class="pi pi-eye"></i>
                                #{noticiaDetalhesBean.noticia.visualizacoes} #{msg['article.views']}
                            </span>
                        </div>
                        
                        <!-- Título -->
                        <h1 class="article-title">#{noticiaDetalhesBean.noticia.titulo}</h1>
                        
                        <!-- Resumo -->
                        <p class="article-summary">#{noticiaDetalhesBean.noticia.resumo}</p>
                        
                        <!-- Categorias -->
                        <div class="category-tags">
                            <ui:repeat value="#{noticiaDetalhesBean.noticia.categorias}" var="categoria">
                                <h:link outcome="/noticias/categoria" styleClass="category-tag">
                                    <f:param name="categoriaId" value="#{categoria.id}"/>
                                    #{categoria.nome}
                                </h:link>
                            </ui:repeat>
                        </div>
                        
                        <!-- Estatísticas -->
                        <div class="article-stats">
                            <span class="stat-item">
                                <i class="pi pi-comments"></i>
                                #{noticiaDetalhesBean.totalComentarios} #{msg['comments.count']}
                            </span>
                            <span class="stat-item">
                                <i class="pi pi-clock"></i>
                                #{noticiaDetalhesBean.tempoLeitura} #{msg['article.reading.time']}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Conteúdo do Artigo -->
        <div class="container">
            <div class="row">
                <div class="col-lg-8">
                    <!-- Imagem principal -->
                    <h:graphicImage value="#{noticiaDetalhesBean.noticia.imagemUrl}" 
                                  alt="#{noticiaDetalhesBean.noticia.titulo}"
                                  styleClass="article-image"
                                  rendered="#{not empty noticiaDetalhesBean.noticia.imagemUrl}"/>
                    
                    <!-- Conteúdo -->
                    <div class="article-content">
                        <h:outputText value="#{noticiaDetalhesBean.noticia.conteudo}" escape="false"/>
                    </div>
                    
                    <!-- Ações do Artigo -->
                    <div class="article-actions">
                        <div class="social-share">
                            <a href="#" class="share-button share-facebook" 
                               onclick="shareOnFacebook(); return false;"
                               title="#{msg['share.facebook']}">
                                <i class="pi pi-facebook"></i>
                            </a>
                            <a href="#" class="share-button share-twitter" 
                               onclick="shareOnTwitter(); return false;"
                               title="#{msg['share.twitter']}">
                                <i class="pi pi-twitter"></i>
                            </a>
                            <a href="#" class="share-button share-linkedin" 
                               onclick="shareOnLinkedIn(); return false;"
                               title="#{msg['share.linkedin']}">
                                <i class="pi pi-linkedin"></i>
                            </a>
                            <a href="#" class="share-button share-whatsapp" 
                               onclick="shareOnWhatsApp(); return false;"
                               title="#{msg['share.whatsapp']}">
                                <i class="pi pi-whatsapp"></i>
                            </a>
                        </div>
                        
                        <div>
                            <p:commandButton value="#{msg['button.print']}" 
                                           onclick="window.print(); return false;"
                                           styleClass="btn btn-outline-secondary btn-sm"
                                           icon="pi pi-print"/>
                        </div>
                    </div>
                    
                    <!-- Seção de Comentários -->
                    <div class="comments-section">
                        <div class="comments-header">
                            <h3>
                                <i class="pi pi-comments"></i>
                                #{msg['comments.title']} (#{noticiaDetalhesBean.totalComentarios})
                            </h3>
                        </div>
                        
                        <!-- Lista de Comentários -->
                        <div id="commentsList">
                            <ui:repeat value="#{noticiaDetalhesBean.comentarios}" var="comentario">
                                <div class="comment-item">
                                    <div class="comment-header">
                                        <span class="comment-author">
                                            <i class="pi pi-user"></i>
                                            #{comentario.autor.nome}
                                        </span>
                                        <span class="comment-date">
                                            <h:outputText value="#{comentario.dataCriacao}">
                                                <f:convertDateTime pattern="#{msg['date.format.short']}"/>
                                            </h:outputText>
                                        </span>
                                    </div>
                                    <div class="comment-content">
                                        #{comentario.conteudo}
                                    </div>
                                </div>
                            </ui:repeat>
                            
                            <!-- Sem comentários -->
                            <div class="text-center py-4" rendered="#{empty noticiaDetalhesBean.comentarios}">
                                <i class="pi pi-comments" style="font-size: 3rem; color: #d1d5db;"></i>
                                <h4 class="mt-3 text-muted">#{msg['comments.no.comments']}</h4>
                                <p class="text-muted">#{msg['comments.be.first']}</p>
                            </div>
                        </div>
                        
                        <!-- Paginação de Comentários -->
                        <div class="text-center mt-3" rendered="#{noticiaDetalhesBean.totalPaginasComentarios > 1}">
                            <p:paginator rows="#{noticiaDetalhesBean.comentariosPorPagina}" 
                                       totalRecords="#{noticiaDetalhesBean.totalComentarios}"
                                       first="#{noticiaDetalhesBean.primeiroComentario}"
                                       pageLinkSize="3"
                                       template="{PreviousPageLink} {PageLinks} {NextPageLink}"
                                       paginatorPosition="bottom">
                                <p:ajax event="page" 
                                      listener="#{noticiaDetalhesBean.onComentariosPageChange}" 
                                      update="commentsList"/>
                            </p:paginator>
                        </div>
                        
                        <!-- Formulário de Comentário -->
                        <div class="comment-form" rendered="#{not empty usuarioLogado}">
                            <h4>#{msg['comments.add.comment']}</h4>
                            <h:form id="commentForm">
                                <div class="mb-3">
                                    <p:inputTextarea value="#{noticiaDetalhesBean.novoComentario.conteudo}" 
                                                   rows="4" 
                                                   cols="50"
                                                   placeholder="#{msg['comments.placeholder']}"
                                                   styleClass="form-control"
                                                   required="true"
                                                   requiredMessage="#{msg['validation.comment.required']}"
                                                   maxlength="1000"/>
                                    <small class="form-text text-muted">
                                        #{msg['comments.max.chars']}
                                    </small>
                                </div>
                                
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">
                                        #{msg['comments.moderation.notice']}
                                    </small>
                                    
                                    <p:commandButton value="#{msg['button.submit.comment']}" 
                                                   action="#{noticiaDetalhesBean.adicionarComentario}"
                                                   styleClass="btn btn-primary"
                                                   icon="pi pi-send"
                                                   update="commentsList commentForm"
                                                   oncomplete="scrollToComments()"/>
                                </div>
                            </h:form>
                        </div>
                        
                        <!-- Login para comentar -->
                        <div class="comment-form text-center" rendered="#{empty usuarioLogado}">
                            <h4>#{msg['comments.login.required']}</h4>
                            <p class="text-muted mb-3">#{msg['comments.login.message']}</p>
                            <p:commandButton value="#{msg['button.login']}" 
                                           action="#{noticiaDetalhesBean.redirecionarParaLogin}"
                                           styleClass="btn btn-primary"
                                           icon="pi pi-sign-in"/>
                        </div>
                    </div>
                </div>
                
                <!-- Sidebar -->
                <div class="col-lg-4">
                    <!-- Notícias Relacionadas -->
                    <div class="related-news">
                        <h4 class="mb-3">
                            <i class="pi pi-bookmark"></i>
                            #{msg['related.news.title']}
                        </h4>
                        
                        <ui:repeat value="#{noticiaDetalhesBean.noticiasRelacionadas}" var="relacionada">
                            <div class="related-item">
                                <h:graphicImage name="images/news-placeholder-small.jpg" 
                                              alt="#{relacionada.titulo}"
                                              styleClass="related-image"
                                              rendered="#{empty relacionada.imagemUrl}"/>
                                <h:graphicImage value="#{relacionada.imagemUrl}" 
                                              alt="#{relacionada.titulo}"
                                              styleClass="related-image"
                                              rendered="#{not empty relacionada.imagemUrl}"/>
                                
                                <div class="related-content">
                                    <h:link outcome="detalhes" styleClass="related-title">
                                        <f:param name="id" value="#{relacionada.id}"/>
                                        #{relacionada.titulo}
                                    </h:link>
                                    <div class="related-date">
                                        <h:outputText value="#{relacionada.dataPublicacao}">
                                            <f:convertDateTime pattern="#{msg['date.format.short']}"/>
                                        </h:outputText>
                                    </div>
                                </div>
                            </div>
                        </ui:repeat>
                        
                        <div class="text-center mt-3" rendered="#{empty noticiaDetalhesBean.noticiasRelacionadas}">
                            <p class="text-muted">#{msg['related.news.empty']}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </c:if>
    </ui:define>
    
    <ui:define name="javascript">
        <script type="text/javascript">
            // Funções de compartilhamento social
            // Referência: Sistema de Temas Claros e Escuros - project_rules.md
            // Compartilhamento deve manter consistência visual com tema ativo
            function shareOnFacebook() {
                const url = encodeURIComponent(window.location.href);
                const title = encodeURIComponent(document.title);
                window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}`, '_blank', 'width=600,height=400');
            }
            
            // Referência: Sistema de Temas Claros e Escuros - project_rules.md
            function shareOnTwitter() {
                const url = encodeURIComponent(window.location.href);
                const title = encodeURIComponent(document.title);
                window.open(`https://twitter.com/intent/tweet?url=${url}&text=${title}`, '_blank', 'width=600,height=400');
            }
            
            // Referência: Sistema de Temas Claros e Escuros - project_rules.md
            function shareOnLinkedIn() {
                const url = encodeURIComponent(window.location.href);
                const title = encodeURIComponent(document.title);
                window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${url}`, '_blank', 'width=600,height=400');
            }
            
            // Referência: Sistema de Temas Claros e Escuros - project_rules.md
            function shareOnWhatsApp() {
                const url = encodeURIComponent(window.location.href);
                const title = encodeURIComponent(document.title);
                window.open(`https://wa.me/?text=${title} ${url}`, '_blank');
            }
            
            // Scroll para comentários
            // Referência: Sistema de Temas Claros e Escuros - project_rules.md
            // Animação de scroll deve respeitar preferências de movimento do usuário
            function scrollToComments() {
                setTimeout(() => {
                    const commentsSection = document.querySelector('.comments-section');
                    if (commentsSection) {
                        commentsSection.scrollIntoView({ behavior: 'smooth' });
                    }
                }, 500);
            }
            
            // Contador de caracteres para comentário
            document.addEventListener('DOMContentLoaded', function() {
                const textarea = document.querySelector('textarea[id*="conteudo"]');
                if (textarea) {
                    const maxChars = 1000;
                    const counter = document.createElement('small');
                    counter.className = 'form-text text-muted float-end';
                    textarea.parentNode.appendChild(counter);
                    
                    function updateCounter() {
                        const remaining = maxChars - textarea.value.length;
                        counter.textContent = `${remaining} caracteres restantes`;
                        counter.style.color = remaining < 50 ? '#dc3545' : '#6c757d';
                    }
                    
                    textarea.addEventListener('input', updateCounter);
                    updateCounter();
                }
            });
            
            // Incrementar visualizações
            if (typeof PrimeFaces !== 'undefined') {
                setTimeout(() => {
                    // Simular incremento de visualização após 5 segundos
                    // (implementar no backend)
                }, 5000);
            }
        </script>
    </ui:define>
    
</ui:composition>
</html>