<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:p="http://primefaces.org/ui"
      xmlns:c="http://xmlns.jcp.org/jsp/jstl/core">

<!-- Referência: Sistema de Temas Claros e Escuros - project_rules.md -->
<ui:composition template="/WEB-INF/templates/template.xhtml">
    
    <ui:define name="title">
        Meu Perfil - #{applicationBean.applicationName}
    </ui:define>
    
    <ui:define name="css">
        <style type="text/css">
            .profile-container {
                max-width: 800px;
                margin: 2rem auto;
                padding: 0 1rem;
            }
            
            .profile-header {
                background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
                color: var(--text-on-primary);
                padding: 2rem;
                border-radius: 10px 10px 0 0;
                text-align: center;
                transition: all 0.3s ease;
            }
            
            .profile-avatar {
                width: 120px;
                height: 120px;
                border-radius: 50%;
                border: 4px solid white;
                margin-bottom: 1rem;
                object-fit: cover;
            }
            
            .profile-name {
                font-size: 1.8rem;
                font-weight: bold;
                margin-bottom: 0.5rem;
                color: var(--text-on-primary);
            }
            
            .profile-role {
                font-size: 1rem;
                opacity: 0.9;
                color: var(--text-on-primary);
            }
            
            .profile-content {
                background: var(--background-color);
                border: 1px solid var(--border-color);
                border-radius: 0 0 10px 10px;
                box-shadow: var(--shadow-md);
                transition: all 0.3s ease;
            }
            
            .profile-tabs {
                border-bottom: 1px solid var(--border-color);
            }
            
            .tab-content {
                padding: 2rem;
                background: var(--background-color);
                color: var(--text-primary);
            }
            
            .form-section {
                margin-bottom: 2rem;
            }
            
            .section-title {
                font-size: 1.2rem;
                font-weight: bold;
                color: var(--primary-color);
                margin-bottom: 1rem;
                padding-bottom: 0.5rem;
                border-bottom: 2px solid var(--border-color);
            }
            
            .form-row {
                display: flex;
                gap: 1rem;
                margin-bottom: 1rem;
            }
            
            .form-group {
                flex: 1;
                margin-bottom: 1rem;
            }
            
            .form-label {
                display: block;
                margin-bottom: 0.5rem;
                font-weight: 600;
                color: var(--text-primary);
            }
            
            .avatar-upload {
                text-align: center;
                margin-bottom: 2rem;
            }
            
            .avatar-preview {
                width: 150px;
                height: 150px;
                border-radius: 50%;
                border: 3px solid var(--border-color);
                margin: 0 auto 1rem;
                object-fit: cover;
                display: block;
                transition: all 0.3s ease;
            }
            
            .upload-info {
                font-size: 0.9rem;
                color: var(--text-secondary);
                margin-top: 0.5rem;
            }
            
            .stats-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 1rem;
                margin-bottom: 2rem;
            }
            
            .stat-card {
                background: var(--background-secondary);
                padding: 1.5rem;
                border-radius: 8px;
                text-align: center;
                border: 1px solid var(--border-color);
                transition: all 0.3s ease;
            }
            
            .stat-card:hover {
                transform: translateY(-2px);
                box-shadow: var(--shadow-lg);
            }
            
            .stat-number {
                font-size: 2rem;
                font-weight: bold;
                color: var(--primary-color);
                display: block;
            }
            
            .stat-label {
                font-size: 0.9rem;
                color: var(--text-secondary);
                margin-top: 0.5rem;
            }
            
            .verification-status {
                display: inline-flex;
                align-items: center;
                gap: 0.5rem;
                padding: 0.5rem 1rem;
                border-radius: 20px;
                font-size: 0.9rem;
                font-weight: 600;
            }
            
            .verified {
                background: var(--success-bg);
                color: var(--success-text);
            }
            
            .not-verified {
                background: var(--warning-bg);
                color: var(--warning-text);
            }
            
            .btn {
                padding: 0.75rem 1.5rem;
                border: none;
                border-radius: 8px;
                font-size: 1rem;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.3s ease;
                text-decoration: none;
                display: inline-block;
            }
            
            .btn-primary {
                background: var(--primary-color);
                color: var(--text-on-primary);
            }
            
            .btn-primary:hover {
                background: var(--primary-color-hover);
                transform: translateY(-1px);
            }
            
            .btn-outline-secondary {
                background: transparent;
                color: var(--text-secondary);
                border: 1px solid var(--border-color);
            }
            
            .btn-outline-secondary:hover {
                background: var(--background-secondary);
                color: var(--text-primary);
            }
            
            .btn-warning {
                background: var(--warning-color);
                color: var(--text-on-primary);
            }
            
            .btn-warning:hover {
                background: var(--warning-color-hover);
                transform: translateY(-1px);
            }
            
            .action-buttons {
                display: flex;
                gap: 1rem;
                justify-content: flex-end;
                margin-top: 2rem;
                padding-top: 2rem;
                border-top: 1px solid var(--border-color);
            }
            
            @media (max-width: 768px) {
                .profile-container {
                    margin: 1rem;
                    padding: 0;
                }
                
                .form-row {
                    flex-direction: column;
                    gap: 0;
                }
                
                .action-buttons {
                    flex-direction: column;
                }
                
                .stats-grid {
                    grid-template-columns: 1fr;
                }
            }
        </style>
    </ui:define>
    
    <ui:define name="content">
        <!-- Referência: Controle de Acesso - project_rules.md -->
        <c:if test="#{not securityBean.authenticated}">
            <script>window.location.href = 'login.xhtml';</script>
        </c:if>
        
        <div class="profile-container">
            <!-- Cabeçalho do Perfil -->
            <div class="profile-header">
                <h:graphicImage value="#{securityBean.loggedUser.avatarUrl != null ? securityBean.loggedUser.avatarUrl : '/resources/images/default-avatar.png'}"
                               styleClass="profile-avatar"
                               alt="Avatar do usuário"/>
                <div class="profile-name">#{securityBean.loggedUser.nomeCompleto}</div>
                <div class="profile-role">#{securityBean.loggedUser.papel.descricao}</div>
                <div class="verification-status #{securityBean.loggedUser.emailVerificado ? 'verified' : 'not-verified'}">
                    <i class="pi #{securityBean.loggedUser.emailVerificado ? 'pi-check-circle' : 'pi-exclamation-triangle'}"></i>
                    #{securityBean.loggedUser.emailVerificado ? 'Email Verificado' : 'Email Não Verificado'}
                </div>
            </div>
            
            <!-- Conteúdo do Perfil -->
            <div class="profile-content">
                <p:tabView styleClass="profile-tabs">
                    
                    <!-- Aba: Dados Pessoais -->
                    <p:tab title="Dados Pessoais">
                        <div class="tab-content">
                            <h:form id="perfilForm" enctype="multipart/form-data">
                                
                                <!-- Upload de Avatar -->
                                <div class="form-section">
                                    <h3 class="section-title">Foto do Perfil</h3>
                                    <div class="avatar-upload">
                                        <h:graphicImage value="#{securityBean.loggedUser.avatarUrl != null ? securityBean.loggedUser.avatarUrl : '/resources/images/default-avatar.png'}"
                                                       styleClass="avatar-preview"
                                                       alt="Preview do avatar"/>
                                        
                                        <p:fileUpload id="avatarUpload"
                                                     mode="simple"
                                                     skinSimple="true"
                                                     label="Escolher Foto"
                                                     accept="image/*"
                                                     maxFileSize="5242880"
                                                     allowTypes="/(\.|\/)(gif|jpe?g|png)$/"
                                                     styleClass="btn btn-outline-primary"/>
                                        
                                        <div class="upload-info">
                                            Formatos aceitos: JPG, PNG, GIF (máx. 5MB)
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Informações Básicas -->
                                <div class="form-section">
                                    <h3 class="section-title">Informações Básicas</h3>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label" for="nome">Nome *</label>
                                            <p:inputText id="nome" 
                                                        value="#{perfilBean.usuario.nome}"
                                                        required="true"
                                                        requiredMessage="Nome é obrigatório"
                                                        maxlength="100"
                                                        styleClass="form-control"
                                                        style="width: 100%"/>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label class="form-label" for="sobrenome">Sobrenome *</label>
                                            <p:inputText id="sobrenome" 
                                                        value="#{perfilBean.usuario.sobrenome}"
                                                        required="true"
                                                        requiredMessage="Sobrenome é obrigatório"
                                                        maxlength="100"
                                                        styleClass="form-control"
                                                        style="width: 100%"/>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label" for="email">Email *</label>
                                        <p:inputText id="email" 
                                                    value="#{perfilBean.usuario.email}"
                                                    required="true"
                                                    requiredMessage="Email é obrigatório"
                                                    maxlength="150"
                                                    styleClass="form-control"
                                                    style="width: 100%"/>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label" for="cpf">CPF</label>
                                            <p:inputMask id="cpf" 
                                                        value="#{perfilBean.usuario.cpf}"
                                                        mask="999.999.999-99"
                                                        readonly="true"
                                                        styleClass="form-control"
                                                        style="width: 100%; background-color: #f3f4f6;"/>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label class="form-label" for="telefone">Telefone</label>
                                            <p:inputMask id="telefone" 
                                                        value="#{perfilBean.usuario.telefone}"
                                                        mask="(99) 99999-9999"
                                                        placeholder="(00) 00000-0000"
                                                        styleClass="form-control"
                                                        style="width: 100%"/>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label" for="dataNascimento">Data de Nascimento</label>
                                        <p:calendar id="dataNascimento" 
                                                   value="#{perfilBean.usuario.dataNascimento}"
                                                   pattern="dd/MM/yyyy"
                                                   showOn="button"
                                                   navigator="true"
                                                   yearRange="1900:2010"
                                                   styleClass="form-control"
                                                   style="width: 100%"/>
                                    </div>
                                </div>
                                
                                <!-- Botões de Ação -->
                                <div class="action-buttons">
                                    <p:commandButton value="Cancelar" 
                                                    action="#{perfilBean.cancelar}"
                                                    styleClass="btn btn-outline-secondary"
                                                    immediate="true"/>
                                    
                                    <p:commandButton value="Salvar Alterações" 
                                                    action="#{perfilBean.salvar}"
                                                    styleClass="btn btn-primary"
                                                    update="perfilForm"/>
                                </div>
                            </h:form>
                        </div>
                    </p:tab>
                    
                    <!-- Aba: Segurança -->
                    <p:tab title="Segurança">
                        <div class="tab-content">
                            <h:form id="segurancaForm">
                                
                                <!-- Alterar Senha -->
                                <div class="form-section">
                                    <h3 class="section-title">Alterar Senha</h3>
                                    
                                    <div class="form-group">
                                        <label class="form-label" for="senhaAtual">Senha Atual *</label>
                                        <p:password id="senhaAtual" 
                                                   value="#{perfilBean.senhaAtual}"
                                                   required="true"
                                                   requiredMessage="Senha atual é obrigatória"
                                                   feedback="false"
                                                   styleClass="form-control"
                                                   style="width: 100%"/>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label" for="novaSenha">Nova Senha *</label>
                                            <p:password id="novaSenha" 
                                                       value="#{perfilBean.novaSenha}"
                                                       required="true"
                                                       requiredMessage="Nova senha é obrigatória"
                                                       feedback="true"
                                                       promptLabel="Digite uma nova senha"
                                                       weakLabel="Fraca"
                                                       goodLabel="Boa"
                                                       strongLabel="Forte"
                                                       styleClass="form-control"
                                                       style="width: 100%"/>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label class="form-label" for="confirmaNovaSenha">Confirmar Nova Senha *</label>
                                            <p:password id="confirmaNovaSenha" 
                                                       value="#{perfilBean.confirmaNovaSenha}"
                                                       required="true"
                                                       requiredMessage="Confirmação de senha é obrigatória"
                                                       feedback="false"
                                                       styleClass="form-control"
                                                       style="width: 100%"/>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Verificação de Email -->
                                <div class="form-section" rendered="#{!securityBean.loggedUser.emailVerificado}">
                                    <h3 class="section-title">Verificação de Email</h3>
                                    <p>Seu email ainda não foi verificado. Clique no botão abaixo para reenviar o email de verificação.</p>
                                    
                                    <p:commandButton value="Reenviar Email de Verificação" 
                                                    action="#{perfilBean.reenviarEmailVerificacao}"
                                                    styleClass="btn btn-warning"
                                                    update="segurancaForm"/>
                                </div>
                                
                                <!-- Botões de Ação -->
                                <div class="action-buttons">
                                    <p:commandButton value="Cancelar" 
                                                    action="#{perfilBean.cancelarSenha}"
                                                    styleClass="btn btn-outline-secondary"
                                                    immediate="true"/>
                                    
                                    <p:commandButton value="Alterar Senha" 
                                                    action="#{perfilBean.alterarSenha}"
                                                    styleClass="btn btn-primary"
                                                    update="segurancaForm"/>
                                </div>
                            </h:form>
                        </div>
                    </p:tab>
                    
                    <!-- Aba: Estatísticas -->
                    <p:tab title="Estatísticas" rendered="#{securityBean.isColaborador or securityBean.isAdmin or securityBean.isFundador}">
                        <div class="tab-content">
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <span class="stat-number">#{perfilBean.totalNoticias}</span>
                                    <div class="stat-label">Notícias Publicadas</div>
                                </div>
                                
                                <div class="stat-card">
                                    <span class="stat-number">#{perfilBean.totalComentarios}</span>
                                    <div class="stat-label">Comentários Recebidos</div>
                                </div>
                                
                                <div class="stat-card">
                                    <span class="stat-number">#{perfilBean.totalVisualizacoes}</span>
                                    <div class="stat-label">Visualizações</div>
                                </div>
                                
                                <div class="stat-card">
                                    <span class="stat-number">#{perfilBean.diasAtivo}</span>
                                    <div class="stat-label">Dias Ativo</div>
                                </div>
                            </div>
                            
                            <div class="form-section">
                                <h3 class="section-title">Atividade Recente</h3>
                                <p>Último acesso: #{perfilBean.ultimoAcesso}</p>
                                <p>Membro desde: #{perfilBean.membroDesde}</p>
                            </div>
                        </div>
                    </p:tab>
                    
                </p:tabView>
            </div>
        </div>
    </ui:define>
    
</ui:composition>
</html>